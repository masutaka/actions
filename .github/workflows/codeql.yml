# Derived from https://github.com/route06/actions/blob/main/.github/workflows/codeql.yml
# Copyright (c) 2024 ROUTE06, Inc.
# Licensed under the MIT License.

name: CodeQL

on:
  workflow_call:

jobs:
  changes:
    name: Filter Paths
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      languages: ${{ steps.format.outputs.languages }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # GitHub Actions組み込みのpathsによるフィルタでは、そのymlで実行する複数のjobそれぞれでpathsによる分岐ができない
      # そのため https://github.com/dorny/paths-filter を使い、フィルタのjob → 各jobの順で実行することで複数jobの分岐を実現する
      - name: Determine languages
        id: determine
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          # ここで指定したkeyがoutputsに出力される
          #
          # 拡張子の一覧は以下を参考にしている
          # https://codeql.github.com/docs/codeql-overview/supported-languages-and-frameworks/#languages-and-compilers
          #
          # JavascriptとTypeScriptの拡張子は意図的に同じキーにまとめている
          # これはCodeQL内部で解析対象として、これらを同一に扱っていることに由来する
          # https://docs.github.com/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning#changing-the-languages-that-are-analyzed
          filters: |
            actions:
              - added|modified: '.github/workflows/*.yml'
              - added|modified: '.github/workflows/*.yaml'
              - added|modified: '**/action.yml'
              - added|modified: '**/action.yaml'
            go:
              - added|modified: '**/*.go'
            javascript:
              - added|modified: '**/*.js'
              - added|modified: '**/*.jsx'
              - added|modified: '**/*.mjs'
              - added|modified: '**/*.es'
              - added|modified: '**/*.es6'
              - added|modified: '**/*.htm'
              - added|modified: '**/*.html'
              - added|modified: '**/*.xhtm'
              - added|modified: '**/*.xhtml'
              - added|modified: '**/*.vue'
              - added|modified: '**/*.hbs'
              - added|modified: '**/*.ejs'
              - added|modified: '**/*.njk'
              # TODO: YAML のみのリポジトリで JavaScript 解析が誤実行される問題の暫定対応
              # 本来 CodeQL は JSON/YAML も JavaScript 対象とするが、一旦コメントアウト
              # - added|modified: '**/*.json'
              # - added|modified: '**/*.yaml'
              # - added|modified: '**/*.yml'
              - added|modified: '**/*.raml'
              - added|modified: '**/*.xml'
              - added|modified: '**/*.ts'
              - added|modified: '**/*.tsx'
              - added|modified: '**/*.mts'
              - added|modified: '**/*.cts'
            python:
              - added|modified: '**/*.py'
            ruby:
              - added|modified: '**/*.rb'
              - added|modified: '**/*.erb'
              - added|modified: '**/*.gemspec'
              - added|modified: '**/Gemfile'
      - name: Format filtered languages
        id: format
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const outputs = {
              actions: ${{ steps.determine.outputs.actions }},
              go: ${{ steps.determine.outputs.go }},
              javascript: ${{ steps.determine.outputs.javascript }},
              python: ${{ steps.determine.outputs.python }},
              ruby: ${{ steps.determine.outputs.ruby }},
            };

            const languages = Object.keys(outputs)
              .filter(lang => outputs[lang]);

            core.setOutput('languages', JSON.stringify(languages));

  languages:
    needs: changes
    if: ${{ needs.changes.outputs.languages != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        language: ${{ fromJson(needs.changes.outputs.languages) }}
    uses: ./.github/workflows/codeql_core.yml
    with:
      language: ${{ matrix.language }}
